<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard KPI UP3</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #chartContainer { width: 95%; max-width: 1200px; height: 650px; }
  select { padding: 6px; margin-bottom: 20px; }
</style>

</head>
<body>

<h2>Dashboard KPI UP3 Tolitoli</h2>

<label>Pilih Bulan:</label>
<select id="monthSelector">
  <option value="0">Januari</option>
  <option value="1">Februari</option>
  <option value="2">Maret</option>
  <option value="3">April</option>
  <option value="4">Mei</option>
  <option value="5">Juni</option>
  <option value="6">Juli</option>
  <option value="7">Agustus</option>
  <option value="8">September</option>
  <option value="9">Oktober</option>
  <option value="10">November</option>
  <option value="11">Desember</option>
</select>

<div id="chartContainer">
  <canvas id="kpiChart"></canvas>
</div>

<script>
const excelURL = "https://raw.githubusercontent.com/UP3Tolis/DASHBOARD/main/NKO%20UP3%20TLI.xlsx";

let indicatorNames = [];
let monthMatrix = [];
let chart;

fetch(excelURL)
  .then(r => r.arrayBuffer())
  .then(buf => {
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets["T.UP3"];

    // Ambil indikator (AT8:AT62)
    const indicators = XLSX.utils.sheet_to_json(sheet, { header: 1, range: "AT8:AT62" });
    indicatorNames = indicators.map(row => row[0]);

    // Ambil nilai pencapaian (BA8:BL62) → Jan s/d Des (12 kolom)
    const values = XLSX.utils.sheet_to_json(sheet, { header: 1, range: "BA8:BL62" });
    monthMatrix = values.map(row => row.map(v => parseFloat(v) || null));

    updateChart(0); // Default: Januari
  });

function updateChart(monthIndex) {
  const filteredNames = [];
  const filteredValues = [];

  for (let i = 0; i < indicatorNames.length; i++) {
    const val = monthMatrix[i][monthIndex];
    if (val !== null && val !== 0 && val !== "") {
      filteredNames.push(indicatorNames[i]);
      filteredValues.push(val);
    }
  }

  const colors = filteredValues.map(v => {
    if (v >= 100) return "green";
    if (v >= 90) return "orange";
    return "red";
  });

  if (chart) chart.destroy();
  const ctx = document.getElementById("kpiChart").getContext("2d");

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: filteredNames,
      datasets: [{
        label: "Realisasi (%)",
        data: filteredValues,
        backgroundColor: colors
      }]
    },
    options: {
      indexAxis: 'y',  // ← Horizontal bar
      responsive: true,
      scales: {
        x: { beginAtZero: true, max: 130 }
      }
    }
  });
}

document.getElementById("monthSelector")
  .addEventListener("change", e => updateChart(parseInt(e.target.value)));
</script>

</body>
</html>
